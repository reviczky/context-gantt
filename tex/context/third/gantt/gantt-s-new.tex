%D \module
%D   [     file=t-gantt,
%D      version=2011.09.24,
%D        title=\CONTEXT\ User Module,
%D     subtitle=Drawing Gantt charts,
%D       author={Adam Reviczky and Aditya Mahajan},
%D         date=\currentdate,
%D    copyright={Adam Reviczky and Aditya Mahajan},
%D      license=Public Domain]

\writestatus{loading}{Gantt charts / MetaPost backend (ver: 2011.09.24)}

\startmodule[gantt-s-mp]
\unprotect

\enabletrackers[interfaces.namespaces,context.flush]

\definenamespace
  [ganttchart]
  [
    \c!type=module,
    \c!name=ganttchart,
    setup=\v!yes,
    \s!parent=ganttchart,
  ]

\definenamespace
  [gantttask]
  [
    \c!type=module,
    \c!name=gantttask,
    \c!command=\v!yes,
    setup=\v!list,
    \s!parent=ganttchart,
  ]

\newtoks \everydefinegantttask

\appendtoks
  \appendtocommalist \currentgantttask \current_gantt_tasks
\to \everydefinegantttask

\starttexdefinition install_gantt_task_handler #1#2
    %% #1 =  \definegantttask[##1][alternative=#2, ##2]
    \def#1{\dotripleargument\redodefinegantttask[#2]}
\stoptexdefinition

\starttexdefinition redodefinegantttask [#1][#2][#3]
    \definegantttask[#2][\c!alternative=#1, #3]
\stoptexdefinition

\install_gantt_task_handler \define_gantt_task      {task}
\install_gantt_task_handler \define_gantt_milestone {milestone}

\def\current_gantt_tasks{}

\startsetups ganttchart::setups
  \def\current_gantt_tasks{}

  \let\task         \define_gantt_task
  \let\milestone    \define_gantt_milestone
\stopsetups


\def\startganttchart
    {\dosingleargument\start_gantt_chart_indeed}

\starttexdefinition start_gantt_chart_indeed [#1]
    \begingroup
    \setupganttchart[#1]
    \processcommacommand[ganttchart::setups,\ganttchartparameter\c!setups]\directsetup
\stoptexdefinition

\starttexdefinition stopganttchart
    \writestatus{DEBUG}{\current_gantt_tasks}
    \initialize_gantt_chart_display
    \processcommacommand[\current_gantt_tasks]\add_gantt_chart_task
    \show_gantt_chart_display
    \endgroup
\stoptexdefinition

%% Temporary method to show a gantt chart as a table
%% Will work on display as a metapost graphic

\newtoks \ganttchartdisplay

\starttexdefinition initialize_gantt_chart_display
  \ganttchartdisplay {}
  \appendtoks
    \NC Name \NC Type \NC Start \NC Stop \NC Float \NC Shape \NC \NR
  \to \ganttchartdisplay
\stoptexdefinition

\starttexdefinition add_gantt_chart_task #1
  \appendtoks
      \NC \namedgantttaskparameter{#1}\c!text
      \NC \namedgantttaskparameter{#1}\c!alternative
      \NC \namedgantttaskparameter{#1}\c!start
      \NC \namedgantttaskparameter{#1}\c!stop
      \NC \namedgantttaskparameter{#1}{float}
      \NC \namedgantttaskparameter{#1}{shape}
      \NC \NR
  \to \ganttchartdisplay
\stoptexdefinition

\starttexdefinition show_gantt_chart_display
    \startTABLE
      \the\ganttchartdisplay
    \stopTABLE
\stoptexdefinition


\setupganttchart
  [
    \c!factor=1000,
    \c!x=1cm,
    \c!y=1em,
    \c!style=\v!normal,
    \c!color=,
    \c!titlestyle=\v!small,
    \c!titlecolor=,
    ledger=\v!off,
    \c!setups=,
  ]


\protect
\stopmodule

\starttext
\startganttchart
  \task      [one]      [text={Task one}, start=1, stop=10, float=3]
  \task      [two]      [text={Second},   start=8, stop=10]
  \milestone [finish]   [shape=circle,    start=10]
\stopganttchart

\stoptext
